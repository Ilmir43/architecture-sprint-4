# Анализ существующих проблем

## Задержки в обработке заказов
1. **Расчёт стоимости изделий в системе MES** занимает от 2–3 минут до 30 минут, что создает узкое место, особенно при увеличении количества заказов.
2. **Недостаточная масштабируемость** для обработки большого числа заказов от новых клиентов (особенно при открытии API для внешних пользователей).

## Высокая нагрузка на систему при росте заказов
1. **Заказы от внешних продавцов через API** сильно увеличили нагрузку на CRM и MES, что привело к просроченным заказам и недовольству клиентов.
2. Потери крупных контрактов из-за сбоев в обслуживании заказов.

## Проблемы с загрузкой и отображением заказов в интерфейсе оператора MES
1. Операторы жалуются на **медленную загрузку первой страницы MES** с дашбордом заказов. Существующий фильтр и пагинация не помогают, так как основная нагрузка исходит от количества запросов и данных, которые обрабатываются и визуализируются.

## Задержки в релизах
1. Часто возникает необходимость **исправления багов уровня high или highest**, что задерживает выход новых версий на продакшн, особенно при высоком росте количества пользователей и требований.

## Отсутствие масштабируемости на уровне баз данных
1. Использование единого инстанса для баз данных может быть неэффективным при увеличении нагрузки, так как это может привести к узким местам при записи и чтении данных.

## Антипаттерны микросервисной архитектуры
1. **Узкое место в обработке сообщений RabbitMQ**:
   - Отсутствие разделения очередей на приоритетные и фоновые задачи может приводить к задержкам в обработке критических заказов.
   - Нет информации о мониторинге производительности очередей RabbitMQ, что усложняет диагностику и устранение задержек.
2. **Тесная связность между сервисами**:
   - MES сильно зависит от CRM через RabbitMQ, что затрудняет автономное масштабирование.
   - API MES и CRM могут быть недостаточно изолированы, что увеличивает риск каскадных ошибок.
3. **Централизованное хранилище файлов**:
   - 3D-файлы сохраняются в одном хранилище, что создаёт потенциальную точку отказа (SPoF). Это ограничивает масштабируемость и может замедлить расчёты в MES.

## Недостатки API сервисов
1. **Отсутствие версии API**:
   - Если API не версионируется, любое изменение может нарушить совместимость с существующими клиентами.
2. **Отсутствие документации**:
   - Недостаточная документация или инструменты (например, OpenAPI) затрудняют развитие API и интеграцию новых клиентов.
3. **Нет гибкости для внешних пользователей**:
   - Отсутствие rate limiting или очередей запросов для API-пользователей делает систему уязвимой для перегрузки.

## Недостаточная наблюдаемость системы
1. **Отсутствие мониторинга RabbitMQ**:
   - Нет данных о нагрузке на очереди, задержках сообщений и отказах.
2. **Логирование и трассировка**:
   - Невозможно отследить полную цепочку обработки заказа (например, от API до MES и CRM), что усложняет диагностику инцидентов.
3. **Метрики производительности**:
   - Отсутствие метрик для сервисов: количество запросов, время обработки, число ошибок.
4. **Отсутствие алертинга**:
   - Нет систем оповещения для обнаружения проблем до их появления у пользователей.

---

# Инициативы для устранения проблем

1. **Масштабирование и оптимизация системы MES для расчета стоимости**:
   - Перевод части расчётов на микросервисы для распределения нагрузки и сокращения времени обработки.
   - Оптимизация алгоритмов расчёта стоимости.
   - Внедрение кэширования расчётов стоимости для часто заказываемых изделий.
2. **Масштабируемость базы данных**:
   - Переход на распределённую базу данных с горизонтальным масштабированием.
   - Внедрение реплик баз данных для уменьшения нагрузки на основной инстанс.
3. **Улучшение производительности интерфейса MES**:
   - Оптимизация запросов на стороне сервера для дашборда заказов.
   - Ограничение данных на первой странице до самых новых и приоритетных заказов.
4. **Обновление CI/CD-процессов**:
   - Внедрение автоматического тестирования E2E и регрессионного тестирования.
   - Перенос части тестирования на pre-prod окружение.
5. **Рефакторинг API для сторонних пользователей**:
   - Внедрение версионирования API.
   - Ограничение количества запросов и внедрение rate limiting.
   - Внедрение кэширования запросов для уменьшения нагрузки на CRM и MES.
6. **Улучшение наблюдаемости системы**:
   - Внедрение мониторинга RabbitMQ (Prometheus, Grafana).
   - Реализация централизованного логирования (ELK Stack).
   - Внедрение трассировки (Jaeger) для отслеживания цепочки обработки заказов.
   - Настройка алертинга.

---

# Приоритеты и целевая архитектура

## Приоритеты:
1. Оптимизация и масштабируемость MES для расчета стоимости.
2. Улучшение производительности интерфейса MES для операторов.
3. Улучшение наблюдаемости системы.

## Целевая архитектура через полгода:
1. **Оптимизированная и распределённая MES-система**:
   - Расчёты стоимости вынесены в отдельный микросервис.
   - Реализовано кэширование и асинхронная обработка.
2. **Масштабируемая архитектура API**:
   - Внедрено версионирование API, rate limiting и кэширование запросов.
3. **Улучшенная наблюдаемость**:
   - Включён мониторинг RabbitMQ, централизованное логирование и распределённая трассировка.

## Три ключевых пункта для реализации за полгода:
1. **Оптимизация и масштабирование MES для расчета стоимости**:
   - Это критично, так как расчеты замедляют выполнение заказов.
2. **Улучшение производительности интерфейса MES**:
   - Ускорение загрузки дашборда позволит операторам быстрее брать заказы в работу.
3. **Улучшение наблюдаемости системы**:
   - Мониторинг и трассировка позволят быстро выявлять и устранять проблемы, предотвращая недовольство клиентов.
