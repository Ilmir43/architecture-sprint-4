# Логи и уровни логирования

## Необходимые логи (уровень INFO)

### Изменение статуса заказа:
- **Системы:** Интернет-магазин, CRM, MES.
- **Содержимое лога:** Время, ID заказа, новый статус, ID пользователя или системы, инициировавшей изменение статуса.

### Создание заказа:
- **Системы:** Интернет-магазин, CRM.
- **Содержимое лога:** Время, ID клиента, ID заказа, список товаров или услуг, данные об источнике (например, B2C или API-пользователь).

### Результаты расчета стоимости:
- **Системы:** MES.
- **Содержимое лога:** Время, ID заказа, рассчитанная стоимость, время расчёта, количество полигонов в 3D-модели (если применимо).

### Передача заказа в очередь RabbitMQ:
- **Системы:** Любая система, передающая сообщения через RabbitMQ.
- **Содержимое лога:** Время, ID заказа, имя очереди, результат отправки (успех/неудача).

### Данные о завершении заказа:
- **Системы:** CRM, MES.
- **Содержимое лога:** Время, ID заказа, статус завершения (успешно/ошибка), оператор, завершивший заказ.

## Другие уровни логирования

- **DEBUG** — использовать для детализированной информации о процессе, например, для отладки или анализа данных, не предназначенных для производства. Рекомендуется включать этот уровень на dev-окружении или при анализе ошибок.
    - Примеры: детализированные данные расчёта стоимости, промежуточные статусы в RabbitMQ.
- **WARN** — для предупреждений, которые не приводят к ошибкам, но могут указывать на потенциальные проблемы.
    - Примеры: попытки повторного расчёта стоимости, превышение среднего времени обработки в API.
- **ERROR** — для ошибок, которые требуют немедленного внимания.
    - Примеры: неудачная передача заказа в RabbitMQ, сбой при расчёте стоимости, ошибки взаимодействия с базой данных.

---

## Мотивация

Внедрение системы логирования позволит:
1. **Ускорить диагностику и решение инцидентов.** Логи помогут оперативно понять, что пошло не так, и сократить время, требуемое на диагностику проблем.
2. **Повысить качество поддержки клиентов.** Системное логирование устранит необходимость разбираться в проблемах со слов клиентов, позволив команде поддержки быстрее и точнее понимать причину сбоев.
3. **Улучшить анализ и отслеживание аномалий.** С помощью логов можно находить аномалии, такие как всплески активности, которые могут указывать на атаки или ошибки в работе сервисов.
4. **Оптимизировать работу с заказами.** Логи помогут анализировать задержки на каждом этапе обработки заказа и своевременно оптимизировать систему.

### Технические и бизнес-метрики, на которые повлияет логирование:
- **Среднее время решения инцидентов** — снизится благодаря доступу к структурированным данным о проблемах.
- **Количество жалоб клиентов на технические сбои** — уменьшится за счёт быстрого обнаружения и устранения причин сбоев.
- **Процент выполненных заказов в срок** — возрастёт за счёт улучшенного контроля над всеми этапами заказа.
- **Время отклика на аномальные события** (например, DDoS-атаки) — сократится благодаря оперативному выявлению аномалий.
- **Процент успешных операций внутри сервисов** — станет стабильнее, так как проблемы будут выявляться и устраняться быстрее.

---

## Приоритетность систем для логирования и трейсинга

1. **MES** — приоритетный компонент, так как он отвечает за расчет стоимости и выполнение заказов, что влияет на сроки обработки. Проблемы в MES напрямую затрагивают клиента и сроки выполнения.
2. **RabbitMQ** — контроль очередей поможет предотвратить потери сообщений и задержки в обработке заказов между системами.
3. **CRM и Интернет-магазин** — это ключевые компоненты, где происходят регистрация и подтверждение заказов. Логирование позволит отслеживать проблемы с получением и подтверждением заказов от клиентов и API-пользователей.

---

## Предлагаемое решение

### Для реализации логирования предлагается использовать следующие технологии:
- **ELK Stack**
    - Elasticsearch для хранения логов и их быстрой индексации.
    - Logstash для сбора и передачи логов из различных источников (API, RabbitMQ и т.д.).
    - Kibana для визуализации логов, настройки дашбордов и поиска по логам.
- **Filebeat или Fluentd** для сбора логов из контейнеров или отдельных серверов и передачи их в Logstash.

### Схема системы с новыми компонентами:
1. Добавить на схему компоненты Logstash, Elasticsearch и Kibana.
2. Обозначить потоки логов от ключевых систем (Интернет-магазин, CRM, MES, RabbitMQ) к Logstash и далее в Elasticsearch.

---

## Политика безопасности логов

### Контроль доступа:
- Настроить аутентификацию и авторизацию, ограничив доступ к Kibana только для пользователей с ролями "Поддержка", "DevOps" и "Администратор".
- Использовать корпоративный LDAP или систему единого входа (SSO) для управления доступом к логам.

### Шифрование данных:
- Настроить TLS для передачи логов между Filebeat/Fluentd и Logstash, а также между Logstash и Elasticsearch.
- Настроить шифрование при хранении для чувствительных данных, чтобы предотвратить несанкционированный доступ.

### Маскирование чувствительных данных:
- Применить маскирование для конфиденциальной информации (например, личных данных клиентов), чтобы предотвратить утечки.

---

## Политика хранения логов

### Индексация и разделение логов:
- Создать отдельные индексы для каждой системы (например, Shop API, CRM API, MES API) для удобства поиска и анализа.

### Время хранения:
- Хранить логи в течение 90 дней для быстрого доступа и анализа, а также архивировать логи за более длительный период (до одного года) в хранилище с более низкой стоимостью.

### Размер хранения:
- Предусмотреть выделение хранилища с учетом объема данных, генерируемых за сутки, и их ретенции. Регулярно анализировать объем данных и при необходимости пересматривать политику хранения.

---

## Превращение системы сбора логов в систему анализа

### Алертинг на аномалии и ошибки:
- Настроить алерты для критичных ошибок (например, ERROR в MES или RabbitMQ) через Alertmanager или другие средства оповещения (например, Slack, почта).
- Установить пороговые значения для обычного количества записей на каждую операцию. Если количество записей резко увеличивается (например, 10 000 запросов в секунду), система должна отправить уведомление о потенциальной атаке или ошибке.

### Поиск аномалий:
- Настроить автоматическое определение аномалий, например, используя машинное обучение в Elasticsearch, чтобы находить необычные всплески активности.
- Использовать инструменты визуализации для регулярного анализа данных и выявления паттернов, указывающих на потенциальные проблемы.
