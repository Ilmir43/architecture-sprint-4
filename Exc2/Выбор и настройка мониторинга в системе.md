
## 1. Мотивация

Внедрение мониторинга позволит компании:

1. **Обеспечить стабильность и доступность системы.** При текущей высокой нагрузке и жалобах на задержки крайне важно оперативно выявлять узкие места и быстро реагировать на инциденты.
2. **Сократить время отклика на проблемы.** Мониторинг поможет заранее обнаружить потенциальные проблемы (например, увеличение времени расчета или задержки с обработкой заказов) и быстро устранить их.
3. **Оптимизировать производительность.** С помощью данных мониторинга можно будет понять, где конкретно система испытывает трудности при увеличении нагрузки, и адаптировать её под растущие требования.
4. **Улучшить клиентский опыт.** Мониторинг позволит быстрее реагировать на задержки, что поможет повысить удовлетворенность клиентов и сократить количество жалоб.
5. **Сохранить клиентов и снизить риски.** При наличии мониторинга компания сможет поддерживать стабильную работу API и сайта, что минимизирует риск потери контрактов и недовольства клиентов.
6. **Опираться на метрики для принятия бизнес-решений:**
	- **Среднее время обработки заказа:** Позволяет бизнесу оценить эффективность системы и процесс выполнения заказов.
	- **Процент выполненных заказов вовремя:** Помогает анализировать соблюдение SLA и управлять репутацией компании.
	- **Количество жалоб клиентов:** Важный индикатор уровня удовлетворённости и влияния технических проблем на бизнес.
	- **Нагрузка API и RabbitMQ:** Показывает пиковые периоды и помогает планировать ресурсы для масштабирования.

---

## 2. Выбор подхода к мониторингу

Система состоит из нескольких компонентов, поэтому рекомендуется использовать подходы, адаптированные к их особенностям:

1. **Для API:** RED-модель, так как она фокусируется на производительности API и анализе запросов.
2. **Для баз данных и серверов:** USE-модель, чтобы отслеживать использование ресурсов и выявлять проблемы насыщенности.
3. **Для бизнес-логики и пользовательского опыта:** Четыре золотых сигнала, обеспечивающие комплексный мониторинг основных параметров системы.

---

## 3. Метрики и их обоснование

### 3.1 Онлайн-магазин и API

Используем RED-модель:

- **Количество запросов (RPS):**
	- **Зачем:** Отслеживает текущую нагрузку на API и рост трафика.
	- **Ярлыки:** Endpoint, статус-код.
	- **Пример:** `api_requests_total{endpoint="/orders", status_code="200"}`.

- **Ошибки (Errors):**
	- **Зачем:** Позволяет находить проблемы в API (например, высокий процент 5xx).
	- **Ярлыки:** Тип ошибки, endpoint.
	- **Пример:** `api_http_errors_total{endpoint="/orders", type="500"}`.

- **Длительность обработки запросов (Duration):**
	- **Зачем:** Показывает производительность API и позволяет находить запросы с высокой задержкой.
	- **Ярлыки:** Endpoint.
	- **Пример:** `api_request_duration_seconds{endpoint="/calculate_price"}`.

- **Количество запросов на пользователя (RPS per user):**
	- **Зачем:** Для анализа аномальной активности (например, ботов) и высоконагруженных пользователей.
	- **Ярлыки:** UserID, endpoint.
	- **Пример:** `api_rps_per_user{user="client_123", endpoint="/orders"}`.

- **Количество одновременных сессий:**
	- **Зачем:** Показывает уровень активности пользователей и общую нагрузку на API. Позволяет отслеживать аномальные всплески активности.
	- **Ярлыки:** UserID, endpoint.
	- **Пример:** `api_simultaneous_sessions_total{user="client_123"}`.

---

### 3.2 RabbitMQ

Используем четыре золотых сигнала:

- **Количество сообщений в очереди:**
	- **Зачем:** Показывает насыщенность и необходимость масштабирования.
	- **Ярлыки:** Имя очереди.
	- **Пример:** `rabbitmq_queue_length{queue="order_queue"}`.

- **Задержка обработки сообщений:**
	- **Зачем:** Диагностика узких мест в очередях.
	- **Пример:** `rabbitmq_message_latency_seconds{queue="order_queue"}`.

- **Количество dead-letter сообщений:**
	- **Зачем:** Выявление необработанных сообщений.
	- **Пример:** `rabbitmq_dead_letter_count{queue="order_queue"}`.

- **Сообщения в обработке:**
	- **Зачем:** Показывает нагрузку на обработчики.
	- **Пример:** `rabbitmq_messages_in_flight{queue="order_queue"}`.

---

### 3.3 Базы данных

Используем USE-модель:

- **Количество соединений:**
	- **Зачем:** Отслеживание проблем с подключениями и возможных утечек.
	- **Пример:** `db_connections_active{db="shop_db"}`.

- **Время выполнения запросов:**
	- **Зачем:** Диагностика медленных запросов.
	- **Пример:** `db_query_duration_seconds{type="SELECT", table="orders"}`.

- **Объём данных:**
	- **Зачем:** Планирование ёмкости и масштабирования.
	- **Пример:** `db_size_bytes{db="shop_db"}`.

- **Использование CPU и памяти:**
	- **Зачем:** Анализ производительности и нагрузки.
	- **Пример:** `db_cpu_usage_percentage`, `db_memory_utilization_bytes`.

---

### 3.4 Бизнес-метрики

- **Время обработки заказов:**
	- **Зачем:** Отслеживание выполнения SLA.
	- **Пример:** `order_processing_time_percentile{percentile="95"}`.

- **Количество просроченных заказов:**
	- **Зачем:** Анализ качества обслуживания.
	- **Пример:** `late_orders_total`.

- **Количество жалоб клиентов:**
	- **Зачем:** Показатель влияния технических проблем на бизнес.
	- **Пример:** `customer_complaints_total`.

---

## 4. План действий

### 4.1 Настроить инфраструктуру мониторинга
- Развернуть time-series базу данных (например, Prometheus).
- Настроить визуализацию с использованием Grafana.
- Добавить Alertmanager для оповещений.

### 4.2 Сбор метрик
- Интегрировать Prometheus-клиент в интернет-магазин, CRM и MES API.
- Добавить Exporters для RabbitMQ и баз данных.

### 4.3 Визуализация
- Создать дашборды в Grafana для разных команд (DevOps, разработка, бизнес).
- Настроить алерты для критических метрик (ошибки 500, нагрузка на CPU).

### 4.4 Подготовить документацию
- Описать ключевые метрики и пороговые значения.
- Провести обучение команды по использованию мониторинга.

### 4.5 Масштабирование и улучшение
- Настроить автошардинг для RabbitMQ.
- Реализовать автоматическое масштабирование API и баз данных в Yandex Cloud.
